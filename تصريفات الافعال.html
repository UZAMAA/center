<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Payment Recorder</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Custom styles for the table */
        th, td {
            min-width: 120px; /* Ensures columns are not too narrow */
            white-space: nowrap;
        }
        .payment-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .payment-cell:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main container for the app -->
    <div id="app" class="w-full max-w-5xl bg-white rounded-3xl shadow-2xl p-8 transition-all duration-300">
        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 id="page-title" class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Student Payment Recorder</h1>
            <div class="flex space-x-2">
                <!-- Button to navigate back to the main grade list -->
                <button id="back-button" class="hidden px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-semibold hover:bg-gray-300 transition-colors duration-200">
                    ‚Üê Back to Grades
                </button>
                <!-- Button to add a new grade or student -->
                <button id="add-button" class="px-6 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200">
                    Add Grade
                </button>
            </div>
        </div>

        <!-- Content area where grades or students will be displayed -->
        <div id="content-container">
            <!-- This area will be dynamically populated by JavaScript -->
        </div>
    </div>

    <!-- Modal for adding grades, students, or column names -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <div id="modal-content">
                <!-- Input fields will be added here dynamically -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="modal-cancel-button" class="px-5 py-2 text-gray-600 rounded-full hover:bg-gray-100 transition-colors">Cancel</button>
                <button id="modal-save-button" class="px-5 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
            <h2 id="confirm-title" class="text-2xl font-bold mb-4 text-gray-800">Confirm Deletion</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="confirm-cancel-button" class="px-5 py-2 text-gray-600 rounded-full hover:bg-gray-100 transition-colors">Cancel</button>
                <button id="confirm-delete-button" class="px-5 py-2 bg-red-600 text-white rounded-full font-semibold hover:bg-red-700 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Use a self-invoking function to avoid polluting the global scope
        (function() {
            // --- DOM Elements ---
            const app = document.getElementById('app');
            const pageTitle = document.getElementById('page-title');
            const addButton = document.getElementById('add-button');
            const backButton = document.getElementById('back-button');
            const contentContainer = document.getElementById('content-container');
            
            // Text Input Modal
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalSaveButton = document.getElementById('modal-save-button');
            const modalCancelButton = document.getElementById('modal-cancel-button');

            // Confirmation Modal
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmCancelButton = document.getElementById('confirm-cancel-button');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');

            // --- Constants and State ---
            const LOCAL_STORAGE_KEY = 'student_payments_data_v2';
            const FIXED_PAYMENT_AMOUNT = 20;
            const NUM_PAYMENT_COLUMNS = 7;

            let currentPage = 'grades';
            let currentGradeId = null;
            let data = {}; // In-memory data store for grades and students

            // --- Utility Functions ---
            const loadData = () => {
                try {
                    const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return storedData ? JSON.parse(storedData) : {};
                } catch (e) {
                    console.error("Could not load data from local storage", e);
                    return {};
                }
            };

            const saveData = () => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error("Could not save data to local storage", e);
                }
            };

            const generateId = () => {
                return '_' + Math.random().toString(36).substring(2, 9);
            };

            const showModal = (title, buttonText) => {
                modalTitle.textContent = title;
                modalSaveButton.textContent = buttonText;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const hideModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalContent.innerHTML = '';
            };

            const showConfirmModal = (message, onConfirmCallback) => {
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
                
                confirmDeleteButton.onclick = () => {
                    onConfirmCallback();
                    hideConfirmModal();
                };
            };

            const hideConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            };

            // --- Render Functions ---

            const renderGrades = () => {
                currentPage = 'grades';
                currentGradeId = null;
                pageTitle.textContent = 'Student Payment Recorder';
                addButton.textContent = 'Add Grade';
                backButton.classList.add('hidden');
                contentContainer.innerHTML = '';

                const gradeIds = Object.keys(data);
                if (gradeIds.length === 0) {
                    contentContainer.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.435 9.172 5 7.5 5S4.168 5.435 3 6.253M12 6.253c1.168-.818 2.828-1.253 4.5-1.253s3.332.435 4.5 1.253m-12 13C5.168 18.565 6.828 19 8.5 19s3.332-.435 4.5-1.253" />
                            </svg>
                            <p class="text-lg">No grades added yet. Click "Add Grade" to get started!</p>
                        </div>
                    `;
                    return;
                }

                gradeIds.forEach(id => {
                    const grade = data[id];
                    const gradeCard = document.createElement('div');
                    gradeCard.className = 'grade-card p-6 bg-gray-50 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 mb-4';
                    gradeCard.dataset.gradeId = id;
                    gradeCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-700 cursor-pointer">${grade.name}</h2>
                            <div class="flex space-x-2">
                                <button class="edit-grade-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300">Edit</button>
                                <button class="delete-grade-button px-3 py-1 bg-red-100 text-red-600 rounded-full text-sm font-semibold hover:bg-red-200">Delete</button>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-gray-500 block mt-2">
                            ${grade.students.length} Student${grade.students.length !== 1 ? 's' : ''}
                        </span>
                    `;
                    // Attach event listener directly to the h2 for navigation
                    gradeCard.querySelector('h2').addEventListener('click', () => {
                        renderStudents(id);
                    });
                    
                    // Attach event listeners for edit and delete buttons and stop propagation
                    gradeCard.querySelector('.edit-grade-button').addEventListener('click', (event) => {
                        event.stopPropagation();
                        editGrade(id);
                    });
                    gradeCard.querySelector('.delete-grade-button').addEventListener('click', (event) => {
                        event.stopPropagation();
                        deleteGrade(id);
                    });

                    contentContainer.appendChild(gradeCard);
                });
            };

            const renderStudents = (gradeId) => {
                const grade = data[gradeId];
                if (!grade) {
                    renderGrades();
                    return;
                }
                currentPage = 'students';
                currentGradeId = gradeId;
                pageTitle.textContent = grade.name;
                addButton.textContent = 'Add Student';
                backButton.classList.remove('hidden');
                contentContainer.innerHTML = '';

                if (grade.students.length === 0) {
                    contentContainer.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 15a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <p class="text-lg">No students in this class yet. Click "Add Student" to add one!</p>
                        </div>
                    `;
                    return;
                }

                const studentTable = document.createElement('div');
                studentTable.className = 'w-full overflow-x-auto';
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg shadow-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Student Name</th>`;

                // Add dynamic payment columns
                grade.columns.forEach(col => {
                    tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`;
                });

                tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="student-list"></tbody>
                    </table>`;
                
                contentContainer.appendChild(studentTable);
                studentTable.innerHTML = tableHTML;
                const studentList = document.getElementById('student-list');

                grade.students.forEach(student => {
                    const studentRow = document.createElement('tr');
                    studentRow.className = 'student-row hover:bg-gray-50 transition-colors duration-200';
                    let rowHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${student.name}</td>`;

                    // Add payment cells for each column
                    for (let i = 0; i < NUM_PAYMENT_COLUMNS; i++) {
                        const payment = student.payments[i];
                        if (payment) {
                            rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-green-800 text-sm bg-green-100 rounded-lg">${payment.date} ($${payment.amount})</td>`;
                        } else {
                            rowHTML += `<td class="payment-cell px-6 py-4 text-center text-gray-400 font-medium border-dashed border-2 border-gray-200 rounded-lg" data-student-id="${student.id}" data-column-index="${i}">+</td>`;
                        }
                    }
                    rowHTML += `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-student-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 mr-2" data-student-id="${student.id}">Edit</button>
                            <button class="delete-student-button px-3 py-1 bg-red-100 text-red-600 rounded-full text-sm font-semibold hover:bg-red-200" data-student-id="${student.id}">Delete</button>
                        </td>`;

                    studentRow.innerHTML = rowHTML;
                    studentList.appendChild(studentRow);
                });

                // Attach event listeners to all dynamic elements
                document.querySelectorAll('.payment-cell').forEach(cell => {
                    cell.addEventListener('click', (event) => {
                        const studentId = event.target.dataset.studentId;
                        const columnIndex = parseInt(event.target.dataset.columnIndex);
                        recordPayment(studentId, columnIndex);
                    });
                });
                document.querySelectorAll('.edit-student-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const studentId = event.target.dataset.studentId;
                        editStudent(studentId);
                    });
                });
                document.querySelectorAll('.delete-student-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const studentId = event.target.dataset.studentId;
                        deleteStudent(studentId);
                    });
                });
            };

            // --- Core Logic Functions (CRUD) ---

            const addGrade = (gradeName) => {
                const newGradeId = generateId();
                data[newGradeId] = {
                    id: newGradeId,
                    name: gradeName,
                    students: [],
                    columns: []
                };
                hideModal();
                promptForColumnNames(newGradeId);
            };
            
            const editGrade = (gradeId) => {
                const grade = data[gradeId];
                if (!grade) return;
                showModal('Edit Grade Name', 'Save');
                modalContent.innerHTML = `<input type="text" id="grade-name-input" value="${grade.name}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors">`;
                modalSaveButton.onclick = () => {
                    const newName = document.getElementById('grade-name-input').value.trim();
                    if (newName) {
                        grade.name = newName;
                        saveData();
                        renderGrades();
                        hideModal();
                    }
                };
                document.getElementById('grade-name-input').focus();
            };

            const deleteGrade = (gradeId) => {
                const grade = data[gradeId];
                if (!grade) return;
                showConfirmModal(`Are you sure you want to delete the grade "${grade.name}" and all of its students? This cannot be undone.`, () => {
                    delete data[gradeId];
                    saveData();
                    renderGrades();
                });
            };

            const addStudent = (studentName) => {
                if (currentGradeId) {
                    const newStudent = {
                        id: generateId(),
                        name: studentName,
                        payments: new Array(NUM_PAYMENT_COLUMNS).fill(null)
                    };
                    data[currentGradeId].students.push(newStudent);
                    saveData();
                    renderStudents(currentGradeId);
                    hideModal();
                }
            };

            const editStudent = (studentId) => {
                const grade = data[currentGradeId];
                const student = grade.students.find(s => s.id === studentId);
                if (!student) return;
                showModal('Edit Student Name', 'Save');
                modalContent.innerHTML = `<input type="text" id="student-name-input" value="${student.name}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors">`;
                modalSaveButton.onclick = () => {
                    const newName = document.getElementById('student-name-input').value.trim();
                    if (newName) {
                        student.name = newName;
                        saveData();
                        renderStudents(currentGradeId);
                        hideModal();
                    }
                };
                document.getElementById('student-name-input').focus();
            };

            const deleteStudent = (studentId) => {
                const grade = data[currentGradeId];
                const studentIndex = grade.students.findIndex(s => s.id === studentId);
                if (studentIndex === -1) return;
                
                const studentName = grade.students[studentIndex].name;
                showConfirmModal(`Are you sure you want to delete the student "${studentName}"? This cannot be undone.`, () => {
                    grade.students.splice(studentIndex, 1);
                    saveData();
                    renderStudents(currentGradeId);
                });
            };

            const recordPayment = (studentId, columnIndex) => {
                const grade = data[currentGradeId];
                if (!grade) return;

                const student = grade.students.find(s => s.id === studentId);
                if (!student) return;

                const newPayment = {
                    date: new Date().toLocaleDateString(),
                    amount: FIXED_PAYMENT_AMOUNT
                };

                student.payments[columnIndex] = newPayment;
                saveData();
                renderStudents(currentGradeId);
            };
            
            const promptForColumnNames = (gradeId) => {
                showModal('Name Your 7 Payment Columns', 'Save Columns');
                let inputsHTML = '';
                for (let i = 0; i < NUM_PAYMENT_COLUMNS; i++) {
                    inputsHTML += `<input type="text" class="column-name-input w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Column ${i + 1} Name...">`;
                }
                modalContent.innerHTML = inputsHTML;

                modalSaveButton.onclick = () => {
                    const inputs = document.querySelectorAll('.column-name-input');
                    const columnNames = Array.from(inputs).map(input => input.value.trim());

                    if (columnNames.every(name => name !== '')) {
                        data[gradeId].columns = columnNames;
                        saveData();
                        renderStudents(gradeId);
                        hideModal();
                    } else {
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'Please name all 7 columns.';
                        errorMessage.className = 'text-red-500 mb-2';
                        modalContent.insertBefore(errorMessage, inputs[0]);
                    }
                };
            };
            
            // --- Event Handlers ---
            const handleAddButtonClick = () => {
                if (currentPage === 'grades') {
                    showModal('Add New Grade', 'Add Grade');
                    modalContent.innerHTML = `<input type="text" id="grade-name-input" placeholder="Enter grade name..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors">`;
                    modalSaveButton.onclick = () => {
                        const gradeName = document.getElementById('grade-name-input').value.trim();
                        if (gradeName) {
                            addGrade(gradeName);
                        }
                    };
                    document.getElementById('grade-name-input').focus();
                } else if (currentPage === 'students') {
                    showModal('Add New Student', 'Add Student');
                    modalContent.innerHTML = `<input type="text" id="student-name-input" placeholder="Enter student name..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors">`;
                    modalSaveButton.onclick = () => {
                        const studentName = document.getElementById('student-name-input').value.trim();
                        if (studentName) {
                            addStudent(studentName);
                        }
                    };
                    document.getElementById('student-name-input').focus();
                }
            };
            
            const handleBackButtonClick = () => {
                renderGrades();
            };

            // --- Initialization ---

            const init = () => {
                data = loadData();
                renderGrades();

                // Attach top-level event listeners
                addButton.addEventListener('click', handleAddButtonClick);
                backButton.addEventListener('click', handleBackButtonClick);
                modalCancelButton.addEventListener('click', hideModal);
                confirmCancelButton.addEventListener('click', hideConfirmModal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal();
                    }
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        hideModal();
                    }
                });
                confirmModal.addEventListener('click', (e) => {
                    if (e.target === confirmModal) {
                        hideConfirmModal();
                    }
                });
            };

            window.onload = init;
        })();
    </script>
</body>
</html>
